## [DOM XSS in `document.write` using source `location.search`](https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-document-write-sink)

## 1. فكرة اللاب

يعرض اللاب ثغرة **DOM-Based XSS** ناتجة عن استخدام JavaScript للدالة:

```javascript
document.write(...)
```

هذه الدالة تُستخدم لكتابة المحتوى مباشرة داخل الصفحة.  
المشكلة أن القيمة المستخدمة تأتي من:

```javascript
location.search
```

أي من **الـ URL** الذي يتحكم فيه المستخدم.  
وبما أنه لا يوجد أي ترميز أو فلترة، يمكن حقن JavaScript قابل للتنفيذ.

---

## 2. تحليل التطبيق

عند استخدام مربع البحث، يتم إرسال الاستعلام في صورة:

```
?search=VALUE
```

ثم يُستخدم هذا الـ VALUE داخل الصفحة عبر `document.write`.  
بقية الأماكن داخل الصفحة تُظهر البيانات بعد ترميزها (HTML encoded)، لكن **document.write** هو النقطة الضعيفة التي تقبل حقن كود مباشر.

---

## 3. خطوات الاستكشاف

1. تم إدخال نص تجريبي لمعرفة مكان ظهوره، مثل:
    
    ```
    ">3l</img>
    ```
    
2. لاحظت أن القيمة تظهر في عناصر HTML أخرى بشكل مُرمّز، لكن جزء **tracking script** يقوم بكتابة القيمة دون ترميز.
    
3. بعد التأكد من أن القيمة تُكتب في الـ DOM عبر `document.write`، أصبح من الممكن حقن JavaScript.
    

---

## 4. الاستغلال

بما أن **document.write** يقوم بحقن HTML مباشرة، تم استخدام الـ payload التالي:

```html
"><script>alert(1)</script>
```

ثم وضعه داخل الرابط:

```
?search="><script>alert(1)</script>
```

عند فتح الرابط، نفّذ المتصفح alert، وتم حل اللاب.

---

## 5. لماذا نجح الهجوم؟

- `location.search` قابل للتحكم بشكل كامل بواسطة المستخدم.
    
- لا توجد أي فلترة أو sanitization.
    
- `document.write` يحقن نصاً خاماً في الصفحة ويُفسَّر كـ HTML/JS.
    
- وبالتالي كود JavaScript يُنفَّذ مباشرة في المتصفح.
    

---

## 6. أمثلة Payloads إضافية

```html
?search=<img src=x onerror=alert(1)>
```

```html
?search=<svg onload=alert(1)>
```

---

## 7. الممارسات الآمنة

- تجنب استخدام `document.write` نهائياً.
    
- استخدام `textContent` أو `innerText` عند عرض مدخلات المستخدم.
    
- تطبيق sanitization قبل إدخال البيانات إلى DOM.
    
- استخدام Content Security Policy (CSP) قوية عند الإمكان.
    

---

إذا كنت تريد توحيد كل لابات الـ DOM XSS في ملف واحد أو أسلوب كتابة معين، أرسل المطلوب.